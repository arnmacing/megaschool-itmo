# Проект: AI-агент для обработки запросов о Университете ИТМО

Данный проект реализует API на базе [FastAPI](https://fastapi.tiangolo.com/), которое принимает запросы от пользователей, классифицирует их релевантность к ИТМО и, при необходимости, формирует ответ в формате JSON. В основе лежит модель GPT-4. Ниже приведена подробная логика работы и структура основных компонентов проекта.

---

## Содержание

1. [Общее описание](#общее-описание)
2. [Установка и запуск](#установка-и-запуск)
3. [Работа эндпоинта `/api/request`](#работа-эндпоинта-apirequest)
4. [Логика ИИ-агента](#логика-ии-агента)
    - [1. Предобработка запроса](#1-предобработка-запроса)
    - [2. Определение релевантности ИТМО](#2-определение-релевантности-итмо)
    - [3. Поиск дополнительных ссылок](#3-поиск-дополнительных-ссылок)
    - [4. Формирование итогового ответа](#4-формирование-итогового-ответа)
5. [Используемые методы и детали решения](#используемые-методы-и-детали-решения)
6. [Структура JSON-ответа](#структура-json-ответа)
7. [Пример запроса и ответа](#пример-запроса-и-ответа)

---

## Общее описание

Проект предназначен для автоматизированной обработки пользовательских запросов, связанных с Университетом ИТМО. Если вопрос имеет прямое отношение к жизни и деятельности вуза, AI-агент генерирует развернутый ответ на русском языке, включает обоснование, а при необходимости — список официальных ссылок (источников). Если запрос не относится к ИТМО, система возвращает соответствующее уведомление.

---

## Установка и запуск

1. **Склонировать репозиторий**:

   ```bash
   git clone https://github.com/arnmacing/megaschool-itmo
   cd <папка_проекта>
   ```

2. **Установить зависимости** (убедитесь, что у вас установлен Python 3.9+):

   ```bash
   pip install -r requirements.txt
   ```

3. **Создать файл `.env`** в корне проекта (подробнее см. [Переменные окружения](#переменные-окружения)):

   ```
   OPENAI_API_KEY=<ваш API-ключ OpenAI>
   SERPER_API_KEY=<ваш API-ключ Serper.dev>
   PROXY_URL=<необязательно, URL вашего прокси>
   ```

4. **Запустить сервер**:

   ```bash
   uvicorn main:app --reload
   ```

   По умолчанию сервер будет доступен на `http://127.0.0.1:8000`.

---

## Работа эндпоинта `/api/request`

- **Маршрут**: `POST /api/request`
- **Тело запроса**: объект в формате JSON со структурой:
  ```json
  {
    "id": <числовой ID запроса>,
    "query": "<текст пользовательского вопроса>"
  }
  ```
- **Пример**:
  ```json
  {
    "id": 1,
    "query": "Где находится главный кампус Университета ИТМО?"
  }
  ```
- **Возвращаемое значение**: `PredictionResponse`:
  ```json
  {
    "id": <числовой ID>,
    "answer": <номер варианта ответа или null>,
    "reasoning": "<строка с обоснованием>",
    "sources": ["<URL_1>", "<URL_2>", "..."]
  }
  ```

Обработка каждого запроса происходит в функции `handle_request` (файл `main.py`), которая вызывает корневую логику предсказания (`predict`) и возвращает ответ в виде схемы `PredictionResponse`.

---

## Логика ИИ-агента

Основная интеллектуальная часть расположена в файле `tools/agent.py`, в функции `predict`. Процесс предсказания можно разбить на несколько стадий:

### 1. Предобработка запроса

1. **Логирование**: входящий запрос (ID, сам текст) записывается в логи.
2. **Очистка**: из текста удаляются спецсимволы, лишние переносы строк и потенциально опасный пользовательский ввод.
3. **Проверка на наличие нумерованных вариантов**: система определяет, есть ли в тексте варианты ответов в стиле «1., 2., 3., ...». Это может влиять на то, как будет формироваться результат.

### 2. Определение релевантности ИТМО

- Система отправляет уточняющий запрос в функцию `classify_relevance`, используя отдельный кусок prompt’а (сообщение роли `"system"`) и текст пользователя.
- `classify_relevance` проверяет, упоминается ли в вопросе университет ИТМО или темы, связанные с ним (студенческая жизнь, зачисление, научная деятельность и т. п.).
- Если запрос **не** касается ИТМО, немедленно возвращается ответ о том, что вопрос выходит за рамки специализации.

### 3. Поиск дополнительных ссылок

Если запрос признан релевантным ИТМО, агент может обратиться к функции `search_links`, которая:
1. Проверяет, есть ли в тексте слова «ИТМО». При их отсутствии добавляет «Университет ИТМО» для повышения точности поиска.
2. Выполняет HTTP-запрос к API [Serper.dev](https://serper.dev/), эмулирующему Google-поиск, и собирает ссылки по ключевым словам.
3. Отбирает до 5 наиболее подходящих ссылок (приоритет отдается официальным ресурсам `itmo.ru` и `news.itmo.ru`).
4. Возвращает набор ссылок, которые потенциально могут быть использованы в итоговом JSON-ответе.

### 4. Формирование итогового ответа

- После определения релевантности и (опционально) получения ссылок, агент формирует итоговое сообщение в формате JSON:
  - **id**: совпадает с переданным в запросе.
  - **answer**: либо `null` (если вопрос не предполагает выбора из вариантов), либо номер выбранного варианта (если таковые указаны в вопросе).
  - **reasoning**: подробное объяснение с фразой «Ответ сгенерирован моделью GPT-4.» в конце.
  - **sources**: список от 0 до 3 URL, связанных с темой вопроса.

Если агент не может корректно распарсить ответ модели в формат JSON, возвращается сообщение об ошибке и пустой список ссылок.

---

## Используемые методы и детали решения

1. **FastAPI** для создания HTTP-сервиса.
2. **GPT-4** (через OpenAI API) для генерации текстовых ответов и классификации.
3. **Serper.dev** (Google-поиск) для извлечения релевантных ссылок.
4. **Pydantic** (модели `PredictionRequest`, `PredictionResponse`) для строгой валидации входных и выходных данных.
5. **Асинхронность**: `async/await` для не блокирующих запросов к API и быстрого отклика даже при множестве одновременных обращений.
6. **Логирование**: запись всех входящих запросов, их очистки, шагов вызова функций, итогового ответа.

---

## Структура JSON-ответа

Ответ от сервера всегда приводится к схеме:

```json
{
  "id": <числовое значение>,
  "answer": <числовое значение или null>,
  "reasoning": "<строка>",
  "sources": ["<URL_1>", "<URL_2>", ...]
}
```

- **id**: тот же, что получен во входном запросе.
- **answer**: если в запросе присутствуют варианты с нумерацией («1.», «2.», и т. д.), сюда попадает номер выбранного варианта. Если вариантов нет — `null`.
- **reasoning**: развернутое объяснение, содержащее суть ответа и обязательно заканчивающееся фразой «Ответ сгенерирован моделью GPT-4.»
- **sources**: максимум три источника (ссылки), если таковые необходимы для обоснования ответа.

---

## Пример запроса и ответа

### Пример запроса

```json
POST /api/request
{
  "id": 5,
  "query": "В каком городе находится главный кампус Университета ИТМО?\n1. Москва\n2. Санкт-Петербург\n3. Екатеринбург"
}
```

### Пример ответа

```json
{
  "id": 5,
  "answer": 2,
  "reasoning": "Главный кампус Университета ИТМО находится в Санкт-Петербурге. Ответ сгенерирован моделью GPT-4.",
  "sources": [
    "https://itmo.ru/ru/",
    "https://abit.itmo.ru/"
  ]
}
```